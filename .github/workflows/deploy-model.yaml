name: Scan and Deploy an AI Model

on:
  workflow_dispatch:
    inputs:
      security_group_uuid:
        description: 'Security Group UUID'
        required: true
        type: string
      model_uri:
        description: 'Model URI to scan and deploy'
        required: true
        type: string

jobs:
  install-cli:
    name: Install Model Security CLI
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        run: pip install uv

      # - name: Source environment variables
      #   run: |
      #     set -a
      #     source .env.local
      #     set +a
      #     echo "MODEL_SECURITY_CLIENT_ID=$MODEL_SECURITY_CLIENT_ID" >> $GITHUB_ENV
      #     echo "MODEL_SECURITY_CLIENT_SECRET=$MODEL_SECURITY_CLIENT_SECRET" >> $GITHUB_ENV
      #     echo "TSG_ID=$TSG_ID" >> $GITHUB_ENV

      - name: Install model-security-client
        run: |
          chmod +x install-modelsec.sh
          PYPI_URL=$(./install-modelsec.sh)
          uv pip install --system model-security-client --index "$PYPI_URL"

      - name: Verify installation
        run: model-security --version

  scan-model:
    name: Scan Model for Security Issues
    runs-on: ubuntu-latest
    needs: install-cli
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        run: pip install uv

      - name: Source environment variables
        run: |
          set -a
          source .env.local
          set +a
          echo "MODEL_SECURITY_CLIENT_ID=$MODEL_SECURITY_CLIENT_ID" >> $GITHUB_ENV
          echo "MODEL_SECURITY_CLIENT_SECRET=$MODEL_SECURITY_CLIENT_SECRET" >> $GITHUB_ENV
          echo "TSG_ID=$TSG_ID" >> $GITHUB_ENV

      - name: Install model-security-client
        run: |
          chmod +x install-modelsec.sh
          PYPI_URL=$(./install-modelsec.sh)
          uv pip install --system model-security-client --index "$PYPI_URL"

      - name: Resolve model URI
        run: |
          MODEL_URI="${{ inputs.model_uri }}"

          # Check if it's a Hugging Face URI
          if [[ "$MODEL_URI" == https://huggingface.co* ]]; then
            echo "Detected Hugging Face URI: $MODEL_URI"
            RESOLVED_MODEL_URI="$MODEL_URI"
          else
            echo "Detected local model filename: $MODEL_URI"
            # Treat as filename in models directory and compute absolute path
            RESOLVED_MODEL_URI="$(pwd)/models/$MODEL_URI"
            echo "Resolved to absolute path: $RESOLVED_MODEL_URI"
          fi

          echo "RESOLVED_MODEL_URI=$RESOLVED_MODEL_URI" >> $GITHUB_ENV

      - name: Run security scan
        run: |
          model-security scan \
            --security-group-uuid ${{ inputs.security_group_uuid }} \
            --model-uri ${{ env.RESOLVED_MODEL_URI }}

  deploy-model:
    name: Deploy Model for Inference
    runs-on: ubuntu-latest
    needs: scan-model
    steps:
      - name: Deploy model (demo)
        run: |
          echo "ðŸš€ Successfully deployed model to production inference endpoint"
          echo "Model URI: ${{ inputs.model_uri }}"
          echo "Security Group: ${{ inputs.security_group_uuid }}"
          echo "Status: âœ… DEPLOYED"
